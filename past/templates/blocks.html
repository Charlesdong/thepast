{% macro people_info_block(user, unbinded) -%}

<!-- 个人信息框 -->
{%if user%}
    <div class="member">
        <div class="avatar">
            <a href="/user/{{user.id}}"><img src="{{user.get_icon_url()}}" target="_blank" alt="{{user.name}}"></a>
        </div>
        <div class="entry">
            <div class="name">
                <a href="/user/{{user.id}}">{{user.name}}</a>
                {%if user.is_pdf_ready()%}
                <sup><a target="_blank" href="/{{user.id}}/pdf">[PDF]</a></sup>
                {%endif%}
                <span><i>N.{{user.id}}</i></span>
            </div>

            <span>
                {%set uas = user.get_alias()%}
                {%for ua in uas%}
                    {%set h = ua.get_homepage_url()%}
                    <span class="from {{h[2]}} oauth">
                        <a title="访问{{h[0]}}" href="{{h[1]}}" target="_blank">{{h[0]}}</a>
                    </span>
                {%endfor%}

                {%if unbinded%}
                    {%for ub in unbinded%}
                        <span class="from {{ub[1]}}">
                            {%if ub[0] == 'W'%}
                            <a title="绑定wordpress" href="/bind/{{ub[1]}}">{{ub[1]}}</a>
                            {%else%}
                            <a title="添加{{ub[2]}}授权登录" href="/connect/{{ub[1]}}">{{ub[1]}}</a>
                            {%endif%}
                        </span>
                    {%endfor%}
                {%endif%}
            </span>
        </div>
    </div>
{%endif%}
<!-- End 个人信息框 -->

{%- endmacro %}

{% macro connect_block() -%}
<div id="navi">
    <ul>
        <li class="login qq"><a title="使用腾讯微博授权登录" href="/connect/qq">qq</a></li>
        <li class="login sina"><a title="使用新浪微博授权登录" href="/connect/sina">sina</a></li>
        <li class="login douban"><a title="使用豆瓣授权登录" href="/connect/douban">douban</a></li>
        <li class="login twitter"><a title="使用 Twitter 授权登录" href="/connect/twitter">twitter</a></li>
        <li class="login renren"><a title="使用人人授权登录" href="/connect/renren">renren</a></li>
        <li class="login instagram"><a title="使用 instagram 授权登录" href="/connect/instagram">instagram</a></li>
    </ul>
</div>
{%- endmacro %}


{% macro notification_block(user, with_flash=True) -%}
    {% set fillup_email = user and not user.get_email()%}

    {% if with_flash or fillup_email %}
    {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs or fillup_email%}
<div class="box" id="notification">
    <div class="inner">
            {%if fillup_email%}
                <li class="tip">请在<a href="/settings">设置页面</a>补充一下你的邮箱，PDF文件和往事提醒，会发送到你的邮箱。</li>
            {%endif%}

            {% for cate, msg in msgs %}
                <li class="{{cate}}">{{msg}}</li>
            {% endfor %}

    </div>
</div>
<div class="sep5"></div>
        {% endif %}
    {% endwith %}
    {% endif %}
{%- endmacro %}


{% macro rightbar_tags_block(tags_list) -%}
{%if tags_list%}
<div class="box">
    <div class="cell">
        <span class="bigger">个人关键字</span>
    </div>

    <div class="cell">
        {%for t in tags_list%}
            <span class="item_node">{{t}}</span>
        {%endfor%}
    </div>

    <div class="inner">
        <span>个人关键字是thepast根据你的timeline自动提取的，如果你觉得不错，请推荐给你的朋友^^</span>
    </div>
</div>
<div class="sep10"></div>
{%endif%}
{%- endmacro %}

{% macro rightbar_intros_block(intros) -%}
    {%if intros%}
    <div class="box">
        <div class="cell">
            <span class="bigger">个人介绍</span>
        </div>

        {% for intro in intros%}
        <div class="inner">
            {{intro|nl2br|safe}}
        </div>
        {% endfor%}
    </div>
    <div class="sep10"></div>
    {%endif%}
{%- endmacro %}


{% macro rightbar_feedback_block() -%}
<div class="box">
    <div class="cell"> <span class="bigger">反馈和帮助</span> </div>

    <div class="cell">
        <li><a href="/share?first_connect=1">推荐给友邻们</a></li>
        <div class="sep5"></div>

        <li><a href="http://douban.com/people/laiwei" target="_blank">我的豆瓣 </a> 
        &nbsp;<a href="http://weibo.com/hellolaiwei" target="_blank">微博 </a>
        &nbsp;<a href="http://twitter.com/hellolaiwei" target="_blank">twitter </a>
        &nbsp;<a href="http://t.qq.com/laiwei" target="_blank">腾讯 </a>
        &nbsp;<a href="http://pinsta.me/u/hellolaiwei" target="_blank">instagram </a>
        </li>
        <div class="sep5"></div>
        <li><a href="mailto:help@thepast.me" target="_blank">给管理员捎个话</a> help@thepast.me</li>
    </div>

    <div class="inner">
        <span class="tip">如果你觉得thepast还不错的话，请<a href="/share?first_connect=1">推荐</a>一下，另欢迎任何建议和吐槽^^</span>
    </div>

</div>
<div class="sep10"></div>
{%- endmacro %}

{% macro rightbar_markdown_block() -%}
<div class="box">
    <div class="cell"> <span class="bigger">Markdown</span> </div>

    <div class="cell">
        &gt; <a href="http://daringfireball.net/projects/markdown/" target="_blank">Markdown标准 </a>
        <div class="sep5"></div>
        &gt; <a href="http://markdown.tw/" target="_blank">格式参考 </a>
    </div>

    <div class="inner">
    <span class="fade">Markdown 是一种轻量级标记语言，创始人为John Gruber和Aaron Swartz。它允许人们“使用易读易写的纯文本格式编写文档，然后转换成有效的XHTML(或者HTML)文档”</span>
    </div>

</div>
<div class="sep10"></div>
{%- endmacro %}

{% macro rightbar_note_block() -%}
<div class="box">
    <div class="cell"> <span class="bigger">日记</span> </div>

    <div class="cell">
        &gt; <a href="/note/create">写日记 </a> &nbsp;&nbsp; &gt; <a href="/notes">日记列表 </a>
    </div>

    <div class="inner">
    <span class="fade">今年写日记，明年再来看!</span>
    </div>

</div>
<div class="sep10"></div>
{%- endmacro %}

{% macro rightbar_googlead_block() -%}
<div class="box">
    <div class="cell"> <span class="bigger">支持</span> </div>

    <div class="cell">
        <p>&gt; <a target="_blank" href="https://www.gittip.com/laiwei/">Tip me on github :)</a></p>
        <p>&gt; <a target="_blank" href="https://me.alipay.com/hellolaiwei">通过支付宝捐助 :)</a></p>
    </div>

    <div class="inner">
        <script type="text/javascript"><!--
        google_ad_client = "ca-pub-3265197373328058";
        /* thepast-rightbar-250w */
        google_ad_slot = "6156094631";
        google_ad_width = 250;
        google_ad_height = 250;
        //-->
        </script>
        <script type="text/javascript"
        src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
        </script>
    </div>

</div>
<div class="sep10"></div>
{%- endmacro %}

{% macro rightbar_tip_block() -%}
<div class="box">
    <div class="inner">
        <p class="tip"></p>
    </div>

</div>
<div class="sep10"></div>
{%- endmacro %}

{% macro story_unit_block(g, repeated_status, sync_list=None) -%}
    <!-- 图片 -->
    {% set s = repeated_status.status_list[0]%}
    {% set data = s.get_data()%}
    {% set atts = data and data.get_attachments() or []%}
    {% set images = data and data.get_images() or [] %}

    {% set thepast_user = s.get_thepast_user()%}
    {% set thirdparty_profile = thepast_user and thepast_user.get_thirdparty_profile(s.site)%}
    {% if s.site == 'R'%}
        {% set user_nickname = thepast_user and thepast_user.name %}
    {% else%}
        {% set user_nickname = thepast_user and (thirdparty_profile.get("name") 
            or thirdparty_profile.get("uid") or thepast_user.name) %}
    {%endif%}
    {% set avatar = thepast_user 
        and (thirdparty_profile.get("avatar") or thepast_user.get_avatar_url())%}

    {% set re_ = s.get_retweeted_data()%}
    {% set re_atts = re_ and re_.get_attachments() or []%}
    {% set re_images = re_ and re_.get_images() or [] %}
    {% set re_user = re_ and re_.get_user() or ""%}
    {% set re_user_nickname = re_user if re_user|isstr else re_user.get_nickname()%}

    <div class="unit">
      
      <!-- Story -->
      <div class="storyUnit" id="story-{{s.id}}">
        <div class="imageUnit">
        {%if avatar%}
          <a href="{{avatar}}"><img src="{{avatar}}" width="32" height="32" alt="{{user_nickname}}"></a>
        {%endif%}
          <div class="imageUnit-content">
            <a href="/user/{{thepast_user.id}}" >{{user_nickname}}</a>&nbsp;
            <span>{{s.create_time.strftime("%Y-%m-%d %H:%M:%S")}}</span>
          </div>
          <div class="pull-right">
            {%for s_ in repeated_status.status_list%}
                {%set from_ = s_.get_origin_uri()%}
                {%if from_%}
                    <span class="from {{from_[0]}} oauth"><a target="_blank" href="{{from_[1]}}"></a></span>
                {%endif%}
            {%endfor%}
          </div>
        </div>
      
        <span class="summary">{{s.summary|safe}}</span>
        
        {%for att in atts%}
        <a href="{{att.get_href()|safe}}">{{att.get_title()}}</a>
        <p>{{att.get_description()|safe}}</p>
        {%endfor%}

        {%if re_user_nickname and re_.get_content()%}
        <span>
            //@{{re_user_nickname}}: {{re_.get_content()|safe}}
        </span>
        {% endif %}


        {%for att in re_atts%}
        <a href="{{att.get_href()|safe}}">{{att.get_title()}}</a>
        <p>{{att.get_description()|safe}}</p>
        {%endfor%}
      
        {% if images %}
        <div class="photoUnit">
        {%for image in images%}
            <img class="post-image" src="{{image}}" alt="" data-magnifyto="400" class="magnify"/>
        {%endfor%}
        </div>
        {% endif %}
      <!-- / Story -->
      
      <!-- Units -->
      <ol class="storyActions">
        <li><a href="#" onclick="javascript:fn_repost_modal({{s.id}})">旧事重提</a></li>
      </ol>
      <!-- / Units -->
      
    </div>

    <div id="modal_reshare_{{s.id}}" class="modal hide fade" 
        tabindex="-1" aria-labelledby="modal-label-reshare" aria-hidden="false">
        <div class="modal-header">
             <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
             <h3 id="modal-label-reshare">旧事重提</h3>
        </div>
        <div class="modal-body">
            <textarea rows=4 style="width:100%;"></textarea>
            <ul class="thumbnails"> </ul>
            {%if sync_list%}
            {%for s in sync_list%}
            <label class="checkbox inline">
                <input type="checkbox" name="provider" value="{{s[0]}}" 
                    {%if s[1] == "Y"%}checked{%endif%}>
                {{g.config.OPENID_TYPE_NAME_DICT[s[0]]}}
            </label>
            {%endfor%}
            {%endif%}
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
            <button class="btn btn-primary" data-dismiss="modal" onclick="javascript:fn_repost_status({{s.id}})">确定</button>
        </div>
    </div>


    <script>
        function fn_repost_status(sid){
            var obj = jQuery("#story-" + sid);
            var content = jQuery("#modal_reshare_" +sid+ " textarea").val();
            var images = new Array();
            jQuery("#modal_reshare_" +sid+ " img").each(function(i, img){
                images.push(jQuery(img).attr("src"));
            });
            var providers = new Array();
            jQuery("#modal_reshare_" +sid+ " input[name='provider']:checked").each(function(i, ck){
                providers.push(jQuery(ck).val());
            });

            console.log(sid + content + images + providers);
            jQuery.ajax({
                type: "POST",
                async: false,
                dataType: "json",
                url: "/reshare_ajax",
                data: {
                    "text": content,
                    "images": images.join("|"),
                    "providers": providers.join("|")
                },
                success: function(data){
                    if (data.ok == '1'){
                    }else{
                        alert(data.msg);
                    }
                }
            });
        }

        function fn_repost_modal(sid){
            var obj = jQuery("#story-" + sid);

            var summary = "#thepast.me# " + jQuery(obj.find(".summary")[0]).html();
            jQuery("#modal_reshare_" +sid+ " textarea").val(summary);

            var images = new Array();
            obj.find(".post-image").each(function(i, img){
                images.push(jQuery(img).attr("src"));
            });
            console.log(images);

            var thumbs = jQuery("#modal_reshare_" +sid+ " .thumbnails");
            thumbs.html("");
            for (var i in images){
                var img = images[i];
                var thumb_id = "thumb-" + sid + "-" + i;
                var thumb_html = '<li class="span4" id="'+ thumb_id +'">'
                + '<i class="icon-remove"></i>'
                + '<a href="#" class="thumbnail">' 
                + '<img src="' + img +  '"></img> </a>'
                + '</li>';
                thumbs.append(jQuery(thumb_html));
                jQuery("#" + thumb_id + " i").click(function(){
                    jQuery("#" + thumb_id).remove();
                });
            }

            
            jQuery("#modal_reshare_" + sid).modal({
                "keyboard": true,
                "show": true,
                "backdrop": "static"
            });
        }
    </script>
{%- endmacro %}

